<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creazione Home Page - La Tavola Perfetta</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="stylehome.css" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="container">
            <h1 id="site-title">La Tavola Perfetta</h1>
            <button class="edit-title-btn" onclick="editTitle()">
                <i class="fas fa-edit"></i>
            </button>
        </div>
    </header>
    <main class="container">
        <section id="home" class="mb-5">
            <div id="carouselExampleIndicators" class="carousel slide mb-4" data-ride="carousel">
                <ol class="carousel-indicators" id="carousel-indicators"></ol>
                <div class="carousel-inner" id="carousel-inner"></div>
                <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
            <button class="btn btn-primary mb-5" onclick="addSlide()">Aggiungi Immagine</button>
        </section>

        <section id="custom-sections"></section>

        <button class="btn btn-success mb-5" onclick="showHistoryForm()">Aggiungi Sezione "La Nostra Storia e Recensioni"</button></br>
        <button class="btn btn-success mb-5" onclick="showWhyChooseUsForm()">Aggiungi Sezione "Perché Sceglierci"</button></br>

        <!-- Pulsante per salvare la pagina -->
        <button class="btn btn-primary mb-5" onclick="savePage()">Salva Pagina</button></br>
        <button class="btn btn-primary mb-5">
            <a href="./menu-creator.html" style="color: white; text-decoration: none;">Procedi alla creazione della pagina Menù</a>
          </button>
    </main>

    <footer>
        <p id="footer-restaurant-name">La Tavola Perfetta</p>
        <p>Development with <strong>RC-ML</strong> by Marco Lunardi</p>
        <button class="footer-edit-btn" onclick="editFooterName()">
            <i class="fas fa-edit"></i>
        </button>
    </footer>

    <div class="modal fade" id="editTitleModal" tabindex="-1" role="dialog" aria-labelledby="editTitleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTitleModalLabel">Modifica Titolo del Sito</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editTitleForm">
                        <div class="form-group">
                            <label for="new-title">Nuovo Titolo</label>
                            <input type="text" class="form-control" id="new-title" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editFooterModal" tabindex="-1" role="dialog" aria-labelledby="editFooterModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editFooterModalLabel">Modifica Nome del Ristorante</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editFooterForm">
                        <div class="form-group">
                            <label for="footer-restaurant-input">Nome del Ristorante</label>
                            <input type="text" class="form-control" id="footer-restaurant-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editParagraphModal" tabindex="-1" role="dialog" aria-labelledby="editParagraphModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editParagraphModalLabel">Modifica Paragrafo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editParagraphForm">
                        <div class="form-group">
                            <label for="new-paragraph">Modifica il Paragrafo</label>
                            <textarea class="form-control" id="new-paragraph" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editSlideModal" tabindex="-1" role="dialog" aria-labelledby="editSlideModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSlideModalLabel">Modifica Diapositiva</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editSlideForm">
                        <div class="form-group">
                            <label for="slide-title">Titolo</label>
                            <input type="text" class="form-control" id="slide-title" required>
                        </div>
                        <div class="form-group">
                            <label for="slide-description">Descrizione</label>
                            <textarea class="form-control" id="slide-description" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="slide-image">Immagine</label>
                            <input type="file" class="form-control-file" id="slide-image" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyFormModal" tabindex="-1" role="dialog" aria-labelledby="historyFormModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyFormModalLabel">Aggiungi Sezione "La Nostra Storia e Recensioni"</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="historyForm">
                        <div class="form-group">
                            <label for="story-text">Testo della Storia</label>
                            <textarea class="form-control" id="story-text" rows="4" required></textarea>
                        </div>
                        <div id="reviews-container">
                            <h5>Recensioni dei Clienti</h5>
                            <div class="form-group review-entry">
                                <label for="review-text-1">Testo della Recensione 1</label>
                                <textarea class="form-control" id="review-text-1" rows="2" required></textarea>
                                <label for="review-author-1">Autore della Recensione 1</label>
                                <input type="text" class="form-control" id="review-author-1" required>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addReview()">Aggiungi Recensione</button>
                        <button type="submit" class="btn btn-primary mt-3">Aggiungi Sezione</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="whyChooseUsFormModal" tabindex="-1" role="dialog" aria-labelledby="whyChooseUsFormModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="whyChooseUsFormModalLabel">Aggiungi Sezione "Perché Sceglierci"</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="whyChooseUsForm">
                        <div class="form-group">
                            <label for="why-choose-text">Testo introduttivo</label>
                            <textarea class="form-control" id="why-choose-text" rows="3" required></textarea>
                        </div>
                        <div id="reasons-container">
                            <h5>Motivi per Sceglierci</h5>
                            <div class="form-group reason-entry">
                                <label for="reason-text-1">Motivo 1</label>
                                <input type="text" class="form-control" id="reason-text-1" required>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addReason()">Aggiungi Motivo</button>
                        <button type="submit" class="btn btn-primary mt-3">Aggiungi Sezione</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let slides = [];
        let slideCounter = 0;
        let reviewCounter = 1;
        let reasonCounter = 1;

        function editTitle() {
            const title = $('#site-title').text();
            $('#new-title').val(title);
            $('#editTitleModal').modal('show');
        }

        $('#editTitleForm').submit(function(e) {
            e.preventDefault();
            const newTitle = $('#new-title').val();
            $('#site-title').text(newTitle);
            $('#footer-restaurant-name').text(newTitle);
            $('#editTitleModal').modal('hide');
        });

        function editFooterName() {
            const footerName = $('#footer-restaurant-name').text();
            $('#footer-restaurant-input').val(footerName);
            $('#editFooterModal').modal('show');
        }

        $('#editFooterForm').submit(function(e) {
            e.preventDefault();
            const newFooterName = $('#footer-restaurant-input').val();
            $('#footer-restaurant-name').text(newFooterName);
            $('#editFooterModal').modal('hide');
        });

        function renderCarousel() {
            const indicators = $('#carousel-indicators');
            const inner = $('#carousel-inner');

            indicators.empty();
            inner.empty();

            slides.forEach((slide, index) => {
                const activeClass = index === 0 ? 'active' : '';
                indicators.append(`
                    <li data-target="#carouselExampleIndicators" data-slide-to="${index}" class="${activeClass}"></li>
                `);
                inner.append(`
                    <div class="carousel-item ${activeClass}">
                        <img class="d-block w-100" src="${slide.image}" alt="Slide ${index + 1}">
                        <div class="carousel-caption d-none d-md-block">
                            <div class="carousel-caption-bg">
                                <h5>${slide.title}</h5>
                                <p>${slide.description}</p>
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deleteSlide(${index})">Elimina</button>
                    </div>
                `);
            });

            if (slides.length > 0) {
                $('.carousel-control-prev, .carousel-control-next').show();
            } else {
                $('.carousel-control-prev, .carousel-control-next').hide();
            }
        }

        function addSlide() {
            $('#editSlideForm').off('submit').on('submit', function(e) {
                e.preventDefault();

                const title = $('#slide-title').val();
                const description = $('#slide-description').val();
                const imageFile = $('#slide-image')[0].files[0];

                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        slides.push({
                            id: slideCounter++,
                            title: title,
                            description: description,
                            image: e.target.result
                        });
                        renderCarousel();
                        $('#editSlideModal').modal('hide');
                    };
                    reader.readAsDataURL(imageFile);
                }
            });

            $('#editSlideForm')[0].reset();
            $('#editSlideModal').modal('show');
        }

        function deleteSlide(index) {
            slides.splice(index, 1);
            renderCarousel();
        }

        function showHistoryForm() {
            $('#historyFormModal').modal('show');
        }

        function addReview() {
            reviewCounter++;
            const reviewHTML = `
                <div class="form-group review-entry">
                    <label for="review-text-${reviewCounter}">Testo della Recensione ${reviewCounter}</label>
                    <textarea class="form-control" id="review-text-${reviewCounter}" rows="2" required></textarea>
                    <label for="review-author-${reviewCounter}">Autore della Recensione ${reviewCounter}</label>
                    <input type="text" class="form-control" id="review-author-${reviewCounter}" required>
                </div>
            `;
            $('#reviews-container').append(reviewHTML);
        }

        $('#historyForm').submit(function(e) {
            e.preventDefault();

            const storyText = $('#story-text').val();
            let reviewsHTML = '';

            $('.review-entry').each(function() {
                const reviewText = $(this).find('textarea').val();
                const reviewAuthor = $(this).find('input').val();
                const reviewId = `review-${reviewCounter++}`;

                reviewsHTML += `
                    <div class="testimonial mb-3" id="${reviewId}">
                        <blockquote class="blockquote">
                            <p class="mb-0">"${reviewText}"</p>
                            <footer class="blockquote-footer">${reviewAuthor}</footer>
                        </blockquote>
                        <div class="buttons">
                            <button class="delete-review-btn" onclick="deleteReview('${reviewId}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button class="edit-review-btn" onclick="editReview('${reviewId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            const sectionId = `section-${slideCounter++}`;

            const sectionHTML = `
                <div class="row history-section section" id="${sectionId}">
                    <div class="col-md-6">
                        <h2 class="text-dark"><i class="fas fa-history text-gold"></i> La Nostra Storia</h2>
                        <p class="text-dark" id="story-text-${sectionId}">${storyText}</p>
                        <button class="edit-section-btn" onclick="editSection('${sectionId}', 'story')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-section-btn" onclick="deleteSection('${sectionId}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h2 class="text-dark"><i class="fas fa-comments text-gold"></i> Recensioni dei Clienti</h2>
                        ${reviewsHTML}
                    </div>
                </div>
            `;

            $('#custom-sections').append(sectionHTML);
            $('#historyFormModal').modal('hide');
            $('#historyForm')[0].reset();
            reviewCounter = 1;
            $('#reviews-container').html(`
                <h5>Recensioni dei Clienti</h5>
                <div class="form-group review-entry">
                    <label for="review-text-1">Testo della Recensione 1</label>
                    <textarea class="form-control" id="review-text-1" rows="2" required></textarea>
                    <label for="review-author-1">Autore della Recensione 1</label>
                    <input type="text" class="form-control" id="review-author-1" required>
                </div>
            `);
        });

        function showWhyChooseUsForm() {
            $('#whyChooseUsFormModal').modal('show');
        }

        function addReason() {
            reasonCounter++;
            const reasonHTML = `
                <div class="form-group reason-entry">
                    <label for="reason-text-${reasonCounter}">Motivo ${reasonCounter}</label>
                    <input type="text" class="form-control" id="reason-text-${reasonCounter}" required>
                </div>
            `;
            $('#reasons-container').append(reasonHTML);
        }

        $('#whyChooseUsForm').submit(function(e) {
            e.preventDefault();

            const introText = $('#why-choose-text').val();
            let reasonsHTML = '';

            $('.reason-entry').each(function() {
                const reasonText = $(this).find('input').val();
                reasonsHTML += `
                    <li><i class="fas fa-check-circle text-gold"></i> ${reasonText}</li>
                `;
            });

            const sectionId = `section-${slideCounter++}`;

            const sectionHTML = `
                <div class="why-choose-us section mb-5" id="${sectionId}">
                    <h2><i class="fas fa-star text-gold"></i> Perché Sceglierci</h2>
                    <p id="paragraph-to-edit-${sectionId}">${introText}</p>
                    <ul>
                        ${reasonsHTML}
                    </ul>
                    <button class="edit-section-btn" onclick="editSection('${sectionId}', 'paragraph')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-section-btn" onclick="deleteSection('${sectionId}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;

            $('#custom-sections').append(sectionHTML);
            $('#whyChooseUsFormModal').modal('hide');
            $('#whyChooseUsForm')[0].reset();
            reasonCounter = 1;
            $('#reasons-container').html(`
                <h5>Motivi per Sceglierci</h5>
                <div class="form-group reason-entry">
                    <label for="reason-text-1">Motivo 1</label>
                    <input type="text" class="form-control" id="reason-text-1" required>
                </div>
            `);
        });

        function editSection(sectionId, type) {
            const paragraphForm = document.querySelector('#editParagraphForm');
            const newParagraphInput = document.querySelector('#new-paragraph');

            if (type === 'story') {
                const storyText = document.querySelector(`#story-text-${sectionId}`).textContent;
                newParagraphInput.value = storyText;

                paragraphForm.onsubmit = function(e) {
                    e.preventDefault();
                    const newParagraph = newParagraphInput.value;
                    document.querySelector(`#story-text-${sectionId}`).textContent = newParagraph;
                    $('#editParagraphModal').modal('hide');
                };
            } else if (type === 'paragraph') {
                const paragraphText = document.querySelector(`#paragraph-to-edit-${sectionId}`).textContent;
                newParagraphInput.value = paragraphText;

                paragraphForm.onsubmit = function(e) {
                    e.preventDefault();
                    const newParagraph = newParagraphInput.value;
                    document.querySelector(`#paragraph-to-edit-${sectionId}`).textContent = newParagraph;
                    $('#editParagraphModal').modal('hide');
                };
            }
            $('#editParagraphModal').modal('show');
        }

        function deleteSection(sectionId) {
            document.querySelector(`#${sectionId}`).remove();
        }

        function editReview(reviewId) {
            const reviewText = document.querySelector(`#${reviewId} blockquote p`).textContent;
            const reviewAuthor = document.querySelector(`#${reviewId} blockquote footer`).textContent;
            const paragraphForm = document.querySelector('#editParagraphForm');
            const newParagraphInput = document.querySelector('#new-paragraph');

            newParagraphInput.value = reviewText;

            paragraphForm.onsubmit = function(e) {
                e.preventDefault();
                const newReviewText = newParagraphInput.value;
                document.querySelector(`#${reviewId} blockquote p`).textContent = newReviewText;
                document.querySelector(`#${reviewId} blockquote footer`).textContent = reviewAuthor;
                $('#editParagraphModal').modal('hide');
            };
            $('#editParagraphModal').modal('show');
        }

        function deleteReview(reviewId) {
            document.querySelector(`#${reviewId}`).remove();
        }

        function savePage() {
    // Rimuovi i comandi di modifica
    document.querySelectorAll('.edit-title-btn, .edit-section-btn, .delete-section-btn, .delete-btn, .footer-edit-btn, .edit-review-btn, .delete-review-btn').forEach(btn => btn.remove());
    document.querySelectorAll('.editable').forEach(el => el.contentEditable = 'false');

    // Raccogli i dati della pagina
    const data = {
        title: document.querySelector('#site-title').innerText,
        slides: getSlidesData(),
        sections: getSectionsData()
    };

    // Invia i dati al server
    fetch('http://127.0.0.1:5000/save_homepage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'  // Imposta il tipo di contenuto a JSON
        },
        body: JSON.stringify(data)  // Converte i dati in formato JSON
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => alert(data.message))
    .catch(error => console.error('Error:', error));
}

function getSlidesData() {
    const slides = [];
    document.querySelectorAll('.carousel-item').forEach((slide, index) => {
        const imgElement = slide.querySelector('img');
        const title = slide.querySelector('.carousel-caption h5').innerText;
        const description = slide.querySelector('.carousel-caption p').innerText;
        const imageSrc = imgElement.src;

        // Verifica se l'immagine è già in base64
        const imageData = imageSrc.startsWith('data:image/') ? imageSrc.split(',')[1] : '';

        slides.push({
            image: `image_${index}.jpg`,  // Nome del file dell'immagine
            title: title,
            description: description,
            data: imageData
        });
    });
    return slides;
}

function getSectionsData() {
    const sections = [];
    document.querySelectorAll('.section').forEach(section => {
        sections.push(section.outerHTML);
    });
    return sections;
}

    </script>
</body>

</html>
